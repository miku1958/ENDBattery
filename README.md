# ENDBattery - 终末地电力优化计算器

ENDBattery 是一个为游戏《明日方舟：终末地》设计的命令行工具，用于计算基地的电力布局方案。

程序通过模拟电池的功率、寿命以及分流器和传送带带来的延迟效应，计算出最佳的分流组合，以最大化电池利用率并减少溢出。

## 环境要求

* macOS 或 Linux
* Swift 5.4 或更高版本

## 使用方法

### 运行

你可以使用 Swift Package Manager 直接运行：

```bash
swift run
```

或者编译为单文件脚本后运行：

```bash
swiftc -O Sources/ENDBattery/main.swift -o battery_opt
./battery_opt
```

### 配置

在使用前，请根据基地情况修改配置文件。打开 `Sources/ENDBattery/main.swift`，在顶部的 `Config` 扩展中进行设置。

```swift
extension Config {
    static let myBase = Config(
        /// 固定消耗的电池类型 (常驻发电机使用的电池)
        staticBattery: .purple,

        /// 需要进行分流优化的电池类型
        analyzedBattery: .purple,

        /// 屏幕左上角显示的总功率需求
        baseRequiredPower: 4775
    )
}

/// 在这里切换要使用的配置
let config: Config = .myBase
```

其他参数：

* `extraBelt`: 补偿路径长度用的额外传送带/分流器数量。
* `showTopSolutions`: 设置输出方案的数量。
* `enableThree`: 是否启用三分流器搜索。

## 输出说明

### 示例

```text
==================================================
所需电池数量: 紫电池: 4个, 紫电池: 1个
基准消耗: 2160.000 颗/天 (1发电机常开)
理论最少: 343.636 颗/天 (100%利用率)
理论可省: 1816.364 颗/天
正在搜索...

==================================================
操作步骤: 2弃  2弃  2弃  2加  2弃  2加  2弃  3弃  3加
--- [步骤数: 9] (净收益: 0.020611 颗/秒, 每天: 1780.833颗) ---
周期: 20736.000秒 | 溢出/秒: 18.094 | 最低电量: 43800.00
最终功率: 175.5401 | 差值: 0.5401
理论每: 47.568 秒 省一颗电池 (基准 1发电机满载)
实际每: 40.529 分钟 浪费一颗电池 (溢出)
计算消耗: 379.167 颗/天
结论: 净收益 每天 省 1780.833 颗电池 (每 48.517 秒 一颗)
```

### 术语

* **操作步骤**: 对应的分流器摆放序列。
  * 已省略预分流的部分, 电池请先放两个三分流, 源石放两个二分流
  * `2` / `3`: 分别代表二分流器和三分流器。
  * `加`: 连接到增加延迟的一侧（长传送带）。
  * `弃`: 连接到无延迟的一侧（短传送带/直连）。
* **净收益**: 相比基准消耗，每天节省的电池数量。
* **溢出/秒**: 平均每秒浪费的功率。
* **最低电量**: 模拟周期内的电网最低值，过低可能导致停电。

## 电池数据

目前代码中配置的电池参数如下：

| 电池类型            | 功率 (W) | 寿命 (s) |
| :------------------ | :------- | :------- |
| 源石 (Originium)    | 50       | 8        |
| 绿电池              | 220      | 40       |
| 蓝电池              | 420      | 40       |
| 紫电池              | 1100     | 40       |
| 低容息壤 (LowEarth) | 1600     | 40       |

如果要调整数值，请直接修改 `Config` 结构体中的 `Battery` 定义。

## License

MIT License
